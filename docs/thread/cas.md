# CAS

并发编程中，为了保证数据的安全，需要满足三个特性：原子性、可见性、有序性。

Java 中可以通过锁和 CAS 操作来实现原子性。另外，在偏向锁、轻量级锁等中都用到了 CAS。

本篇文章介绍 CAS 的两方面内容：

1. CAS 的原理是什么？
2. CAS 会出现哪些问题？



## 原理

CAS（Compare And Swap），即比较并交换。

CAS(V,A,B) 方法有三个参数

- V: 一个内存地址存放的实际值
- A:旧值
- B:更新的值

具体操作就是将内存中的实际值跟旧值进行比较，如果相等就将内存值更新为新值，并返回 true，否则直接返回 false。

## 问题

### ABA 问题

CAS 需要检查操作值有没有发生改变，如果没有发生改变则更新。但是存在这样一种情况：如果一个值原来是 A，变成了 B，然后又变成了 A，那么在 CAS 检查的时候会认为没有改变，但是实质上它已经发生了改变，这就是 ABA 问题。

解决思路就是使用版本号，在变量前追加是版本号。Java 1.5 之后可以使用 AtomicStampedReference 来解决 ABA 问题。

### 循环时间长开销大

自旋 CAS 如果长时间不成功，会给 CPU 带来非常大的执行开销。

解决思路就是增加自选次数、自旋时间限制。

### 只能保证一个共享变量的原子操作

当对一个共享变量执行操作时，可以使用自旋 CAS 来保证原子操作，但是对多个共享变量操作时，就无法保证。

解决思路：可以通过加锁来保证原子性。或者可以把多个变量合并成一个共享变量来操作。