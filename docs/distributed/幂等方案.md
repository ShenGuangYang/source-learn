# 幂等操作
## 幂等的概念
分布式系统中的幂等性概念：前端发起的api请求、消息的重复推送时，不会因为多次处理而产生了错误数据。

## 幂等的场景

可能会发送重复请求或者重复消费的场景：
- 网络波动可能会引起重复请求
- 上游业务推送消息时出现异常，导致重复推送
- 用户重复点击操作按钮
- 分布式框架中的重试机制

## 解决方案

### 悲观锁
获取数据的时候加锁获取
`select * from table_name where id = 1 for update` 
悲观锁使用时一般伴随事务一起使用，数据锁定时间可能会很长，根据实际情况选用

### 乐观锁
乐观锁只是在更新数据那一刻锁表，其他时间不锁表，所以相对于悲观锁，效率更高。
乐观锁的实现方式多种多样可以通过version或者其他状态条件：
- `update table_name set name=#name#,version=version+1 where id = 1 and  version=#version#` 
- `update table_name set count=count-#count# where count-#count# >= 0`

乐观锁的更新操作，最好用主键或者唯一索引来更新,这样是行锁，否则更新时会锁表。
高并发下，会导致数据库压力剧增。

### 唯一索引
针对某些业务，来建立唯一索引。
比如注册业务，一个手机号只能注册一个账号，可以针对手机号建立唯一索引。
要点：
唯一索引或唯一组合索引来防止新增数据存在脏数据

### 全局唯一id
如果使用全局唯一id，根据业务和内容生成的一个全局id，根据这个id是否存在，来判断是否已经执行。如果不存在，则存储到redis，如果存在则表示这个方案已经执行。

### token机制
处理流程
1. 数据提交前要向服务的申请token，token放到redis并设置token有效时间
2. 服务器判断token是否存在redis中，存在表示第一次请求，可以删除token成功之后继续执行业务。

不是业务处理完再删掉token，是因为有可能在删除token的时候出现异常，在进行再次处理。
先删掉token

### 分布式锁
某个业务构建全局唯一索引比较困难，这时候可以引入分布式锁，在业务系统插入数据或者更新数据时，先获取分布式锁，然后在做操作，操作完释放锁。
要点：
某个长流程处理过程要求不能并发执行，可以在流程执行之前根据某个标志(用户ID+业务标识等)获取分布式锁，其他流程执行时获取锁就会失败，也就是同一时间该流程只能有一个能执行成功，执行完成后，释放分布式锁。


### 状态机
在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机(状态变更图)，就是业务单据上面有个状态，状态在不同的情况下会发生变更，一般情况下存在有限状态机，这时候，如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。