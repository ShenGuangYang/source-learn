# 分布式容错

主要包含熔断、隔离、限流、降级



## 熔断

​		在高并发的情况下，如果达到一定的极限(可以自己设置阈值),如果流量超出了设置的阈值，然后拒绝访问，保护当前服务。当服务器达到最大的承受能力的之后，直接拒绝访问服务，然后调用降级方法，返回友好提示。

## 隔离

​		我们知道计算资源都是有限的，cpu，内存，队列，线程池都是资源，他们都是限定的资源数，如果不进行隔离，一个服务的调用可能要消耗很多的线程资源，把其他服务的资源都给占用了，那么可能出现应为一个服务的问题连带效应造成其他服务不能进行访问。

## 限流

​		让大流量的访问冲进去我们的服务时，我们需要一定的限流措施，比方说我们规则一定时间内只允许一定的访问数从我们的资源过，如果再大的化系统会出现问题，那么就需要限流保护。

### 滑动窗口

​		发送和接受方都会维护一个数据帧的序列，这个序列被称作窗口。发送方的窗口大小由接受方确定，目的在于控制发送速度，以免接受方的缓存不够大，而导致溢出，同时控制流量也可以避免网络拥塞。下 面图中的4,5,6号数据帧已经被发送出去，但是未收到关联的ACK，7,8,9帧则是等待发送。可以看出发送 端的窗口大小为6，这是由接受端告知的。此时如果发送端收到4号ACK，则窗口的左边缘向右收缩，窗 口的右边缘则向右扩展，此时窗口就向前“滑动了”，即数据帧10也可以被发送。

![](image/limit-3.png ':size=50%')

### 漏桶

​		桶本身具有一个恒定的速率往下漏水，而上方时快时慢的会有水进入桶内。当桶还未满时，上方的水可 以加入。一旦水满，上方的水就无法加入。桶满正是算法中的一个关键的触发条件(即流量异常判断成 立的条件)。而此条件下如何处理上方流下来的水，有两种方式

在桶满水之后，常见的两种处理方式为: 

1. 暂时拦截住上方水的向下流动，等待桶中的一部分水漏走后，再放行上方水。
2. 溢出的上方水直接抛弃。

**特点**

1. 漏水的速率是固定的
2. 即使存在突然注水量变大的情况，漏水的速率也是固定的

![](image/limit-1.png ':size=30%')

### 令牌桶

​		令牌桶算法是网络流量整形(Traffic Shaping)和速率限制(Rate Limiting)中最常使用的一种算法。

​		典型情况下，令牌桶算法用来控制发送到网络上的数据的数目，并允许突发数据的发送。

​		令牌桶是一个存放固定容量令牌(token)的桶，按照固定速率往桶里添加令牌; 令牌桶算法实际上由三 部分组成:两个流和一个桶，分别是令牌流、数据流和令牌桶

**令牌流与令牌桶**

​		系统会以一定的速度生成令牌，并将其放置到令牌桶中，可以将令牌桶想象成一个缓冲区(可以用队列 这种数据结构来实现)，当缓冲区填满的时候，新生成的令牌会被扔掉。

![](image/limit-2.png ':size=30%')

## 降级

​		如果说系统后题无法提供足够的支撑能力，那么需要一个降级能力，保护系统不会被进一步恶化，而且可以对用户提供比较友好的柔性方案，例如告知用户暂时无法访问，请在一段时候后重试等等。