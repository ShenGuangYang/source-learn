# volatile

本篇文章介绍并发编程中常用的 volatile 关键字。主要介绍两方面内容：
- volatile 有哪些特性，可以用来做什么？
- volatile 实现原理。

## 保证各线程间共享变量的可见性

volatile 保证了不同线程对 volatile 修饰变量进行操作时的可见性。

**对于一个 volatile 修饰的变量，其他线程总是能看到这个变量最后的写入。**

## volatile 是如何保证可见性的呢？

对于 volatile修饰的变量，在生成汇编代码的时候会生成 `LOCK` 指令，这个指令主要做如下两件事：

1. 把工作内存的变量写入到主内存
2. 通过缓存一致性强制刷新把主内存的数据强制写入各个工作内存中的变量

!> 为什么不能保证原子性？<br/>因为在刷新的工作内存的过程是不安全的。

> 举例：中断线程时常采用这种标记办法。

## volatile 是如何保存有序性？

volatile 在生成指令中加入了内存屏障来禁止特定类型的重排序。

volatile 能禁止指令重排序，保证了程序会严格按照代码的先后顺序执行，即保证了有序性。

volatile的禁止重排序规则：

1. 当第二个操作是volatile写时，不管第一个操作是什么，都不能重排序。这个规则确保volatile写之前的操作不会被编译器重排序到volatile写之后。
2. 当第一个操作是volatile读时，不管第二个操作是什么，都不能重排序。这个规则确保volatile读之后的操作不会被编译器重排序到volatile读之前。
3. 当第一个操作是volatile写，第二个操作是volatile读时，不能重排序。















